import { validationResult } from 'express-validator';
import { errorFormatter } from '../utils/utils-validation.js';
import UserInputValidationError from '../errors/UserInputValidationError.js';
import { createDebugNamespace } from '../logger/logger.js';
import ajv from '../schemas/json-validator.js';

const validationDebug = createDebugNamespace('hottakes:middleware:validation');

/**
 * Field validation middleware.
 * This middleware must be used after the express-validator middleware. It handles the errors generated by the validation.
 * If no error is generated, then the next middleware is called, otherwise a response with status 400 is sent.
 * @param {Express.Request} req - Express request object.
 * @param {Express.Response} res - Express response object.
 * @param next - Next middleware to execute.
 */
export const validateFields = (req, res, next) => {
    validationDebug('Validation middleware execution: user inputs validation');
    try {
        validationResult(req).throw();
        validationDebug('All fields are valid');
        next();
    } catch (error) {
        error = error.formatWith(errorFormatter).array();
        return next(new UserInputValidationError(error));
    }
};

/**
 * Payload validation middleware.
 * Returns a middleware that validates the body against the specified JSON schema. If there is an error, call the next error middleware with a UserInputValidationError.
 * @param {string} schemaName - Name of the schema to uszer for the validation.
 */
export const validatePayload = (schemaName) => {
    validationDebug(`Create the payload validator for the ${schemaName} schema`);
    return (req, res, next) => {
        validationDebug('Validation middleware execution: payload validation');
        const validate = ajv.getSchema(schemaName);

        // Throws an error if the schema doesn't exist
        if (!validate) {
            return next(new Error(`The JSON schema ${schemaName} doesn't exist`));
        }

        // Calls the next middleware if the body is valid
        if (validate(req.body)) {
            return next();
        }

        // Generates a UserInputValidationMiddleware if the body is invalid
        let errors = [];
        for (const error of validate.errors) {
            errors.push({
                property: error.instancePath,
                message: error.message,
            });
        }
        return next(new UserInputValidationError(errors));
    };
};
